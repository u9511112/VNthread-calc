<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰™æ¿å ±åƒ¹è¨ˆç®—å™¨</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; background-color: #f2f2f7; padding: 15px; padding-bottom: 100px; color: #333; margin: 0; }
        .container { position: relative; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); max-width: 800px; margin: 0 auto; }
        h2 { text-align: center; color: #333; margin-bottom: 15px; font-weight: 700; margin-top: 5px; }
        
        #expiry-badge { position: absolute; top: 15px; right: 15px; z-index: 99; font-size: 0.75rem; background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 12px; display: none; font-weight: bold; border: 1px solid #c8e6c9; }

        .top-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .top-controls select { padding: 10px; font-size: 15px; border-radius: 8px; background-color: #f8f9fa; border: 1px solid #ccc; }
        
        .auth-group { background: #e1f5fe; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #b3e5fc; }
        .form-group { margin-bottom: 15px; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; color: #555; }
        
        select, input[type="number"], input[type="text"], input[type="password"] { width: 100%; padding: 14px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; background-color: #fff; box-sizing: border-box; appearance: none; -webkit-appearance: none; }
        select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; }
        input:focus, select:focus { border-color: #007aff; outline: none; }
        
        .var-section { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .var-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .var-input { width: 80px !important; padding: 8px !important; text-align: center; color: #d35400; font-weight: bold; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .check-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; padding: 2px; }
        .check-item input { width: 20px; height: 20px; accent-color: #007aff; }
        
        .btn-calc { width: 100%; background-color: #007aff; color: white; font-size: 1.2rem; font-weight: bold; padding: 16px; border: none; border-radius: 12px; margin-top: 25px; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3); cursor: pointer; }
        .btn-calc:active { transform: scale(0.98); background-color: #0062cc; }
        
        .result-box { background: #1c1c1e; color: white; padding: 25px; border-radius: 15px; margin-top: 25px; text-align: center; }
        .price-container { display: flex; justify-content: center; align-items: baseline; gap: 5px; }
        .price-val { font-size: 2.5rem; font-weight: 800; color: #30d158; line-height: 1.2; }
        .currency-unit { font-size: 1.2rem; color: #8e8e93; font-weight: 600; }
        #result-log { font-size: 0.85rem; margin-top: 15px; color: #aaa; text-align: left; white-space: pre-line; line-height: 1.5; border-top: 1px solid #333; padding-top: 15px; }
        .error-msg { background: #ffebee; color: #c62828; padding: 12px; border-radius: 8px; margin-top: 15px; display: none; font-weight: bold; text-align: center; font-size: 0.95rem; }
        
        .quote-info-box { background: #e8f5e9; padding: 20px; border-radius: 12px; margin-top: 30px; border: 1px solid #c8e6c9; }
        .quote-info-box label { color: #2e7d32; font-size: 0.9rem; }
        .quote-title { font-weight: bold; font-size: 1.1rem; color: #1b5e20; margin-bottom: 15px; text-align: center; border-bottom: 2px solid #a5d6a7; padding-bottom: 10px; }
        
        .btn-export { width: 100%; color: white; font-weight: bold; padding: 16px; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; margin-top: 15px; background-color: #27ae60; }
        .btn-export:active { transform: scale(0.98); }

        .copyright { text-align: center; margin-top: 30px; font-size: 0.8rem; color: #8e8e93; }
    </style>
</head>
<body>

    <div class="container">
        <div id="expiry-badge">â³ é©—è­‰ä¸­...</div>

        <h2 id="t_title">æ“ç‰™æ¿è¨ˆç®—å™¨</h2>

        <div class="top-controls">
            <select id="lang" onchange="changeLanguage()">
                <option value="zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ (ç¹é«”)</option>
                <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                <option value="en">ğŸ‡ºğŸ‡¸ English</option>
            </select>
            <select id="currency" onchange="changeCurrency()">
                <option value="TWD">NT$ å°å¹£ (TWD)</option>
                <option value="VND">â‚« è¶Šç›¾ (VND)</option>
                <option value="USD">$ ç¾é‡‘ (USD)</option>
            </select>
        </div>

        <div class="form-group auth-group">
            <label id="t_auth" style="color: #0277bd;">ğŸ”‘ ç³»çµ±æˆæ¬Šç¢¼ (Auth Code)</label>
            <input type="password" id="auth_token" placeholder="è«‹è¼¸å…¥æˆæ¬Šç¢¼" style="border: 1px solid #0288d1;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group"><label id="t_thick">åšåº¦ (Thickness)</label><input type="number" id="t" placeholder="25" step="0.1"></div>
            <div class="form-group"><label id="t_height">é«˜åº¦ (Height)</label><input type="number" id="h" placeholder="30" step="0.1"></div>
            <div class="form-group"><label id="t_fixed">å›ºå®šé•· (Fixed)</label><input type="number" id="f" placeholder="76" step="0.1"></div>
            <div class="form-group"><label id="t_moving">ç§»å‹•é•· (Moving)</label><input type="number" id="m" placeholder="89" step="0.1"></div>
        </div>

        <div class="form-group full-width">
            <label id="t_type">é¡åˆ¥ (Type)</label>
            <select id="type">
                <option value="TB" id="t_type_tb">æ©Ÿæ¢°ç‰™æ¿ (Machine / T-B)</option>
                <option value="Pointed" id="t_type_pt">å°–å°¾ç‰™æ¿ (Pointed Tail)</option>
            </select>
        </div>

        <div class="form-group">
            <label id="t_discount" style="color:#ff3b30;">æŠ˜æ‰£ (Discount)</label>
            <select id="discount"></select>
        </div>

        <div class="form-group" id="wire-fee-box" style="padding:10px; border:1px dashed #999; border-radius:8px;">
            <label id="t_wire">ç·šå‰²è²» (Wire Cut)</label>
            <select id="wire">
                <option value="0" id="t_wire_none">ç„¡ (None)</option>
                <option value="116000">JP ç‰™æ¿ (116,000 VND / 170 TWD)</option>
                <option value="231000">é JP (231,000 VND / 340 TWD)</option>
            </select>
        </div>

        <div class="var-section">
            <div class="var-row">
                <label class="check-item"><input type="checkbox" id="opt_skh9" onchange="toggleInput('val_skh9')"> <span id="t_opt_skh9">SKH-9 (é«˜é€Ÿé‹¼)</span></label>
                <div class="var-input-group">x <input type="number" id="val_skh9" class="var-input" value="1.8" step="0.1" disabled></div>
            </div>
            <div class="var-row">
                <label class="check-item"><input type="checkbox" id="opt_refurbish" onchange="toggleInput('val_refurbish')"> <span id="t_opt_ref">ç¿»ä¿®å“ (Refurbish)</span></label>
                <div class="var-input-group">x <input type="number" id="val_refurbish" class="var-input" value="0.6" step="0.1" disabled></div>
            </div>
        </div>

        <div class="options-grid">
            <label class="check-item"><input type="checkbox" id="opt_deepen20"> <span id="t_o1">æ©Ÿç‰™åŠ æ·± (+20%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_triangle"> <span id="t_o2">ä¸‰è§’ç‰™/åå…¥å£ (+30%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_special50"> <span id="t_o3">ç‰¹æ®Šç‰™å‹ (+50%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_pitch04"> <span id="t_o4">ç‰™è·0.4ä»¥ä¸‹ (+15%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_shapeX2"> <span id="t_o5">è§’/æ–¹ç‰™ (x2)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_twoSpecs"> <span id="t_o6">é›™è¦æ ¼ (+30%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_doubleLeft"> <span id="t_o7">é›™ç‰™/å·¦ç‰™ (+10%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_angle3048"> <span id="t_o8">ç‰™å±±30-48åº¦ (+10%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_4faces"> <span id="t_o9">å››é¢ç”¨ (+50%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_surface"> <span id="t_o10">è¡¨é¢è™•ç† (+15%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_straight42"> <span id="t_o11">ç›´é½’42ç‰™+ (+30%)</span></label>
        </div>

        <button class="btn-calc" onclick="calculate()" id="t_btn">é€£ç·šè¨ˆç®— (Calculate)</button>
        <div id="error-box" class="error-msg"></div>

        <div class="result-box">
            <div class="price-container">
                <span class="price-val" id="final-price">0</span>
                <span class="currency-unit" id="final-currency">TWD</span>
            </div>
            <div id="result-log"></div>
        </div>

        <div class="quote-info-box">
            <div class="quote-title" id="t_quote_title">ğŸ“„ å ±åƒ¹å–®å®¢æˆ¶è³‡è¨Š (Quotation Info)</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group"><label id="t_quote_to">å®¢æˆ¶åç¨± (To)</label><input type="text" id="cust_name" placeholder="è¯åˆå…¬å¸"></div>
                <div class="form-group"><label id="t_quote_attn">è¯çµ¡äºº (Attn)</label><input type="text" id="cust_attn" placeholder="é™³å…ˆç”Ÿ"></div>
                <div class="form-group"><label id="t_quote_tel">é›»è©± (Tel)</label><input type="text" id="cust_tel" placeholder="0868 549 896"></div>
                <div class="form-group"><label id="t_quote_qty">æ•¸é‡ (Qty)</label><input type="number" id="qty" value="1" min="1"></div>
            </div>
            <button class="btn-export" onclick="exportExcel()">â¬‡ï¸ åŒ¯å‡º Excel å ±åƒ¹å–®</button>
        </div>

        <div class="copyright">Â© è¬æ™ºç¿” u9511112@gmail.com</div>
    </div>

    <script>
        const i18n = {
            zh: {
                title: "æ“ç‰™æ¿è¨ˆç®—å™¨", auth: "ğŸ”‘ ç³»çµ±æˆæ¬Šç¢¼", thick: "åšåº¦ (Thickness)", height: "é«˜åº¦ (Height)", 
                fixed: "å›ºå®šé•· (Fixed)", moving: "ç§»å‹•é•· (Moving)", type: "é¡åˆ¥ (Type)", discount: "æŠ˜æ‰£ (Discount)", wire: "ç·šå‰²è²» (Wire Cut)",
                type_tb: "æ©Ÿæ¢°ç‰™æ¿ (T-B)", type_pt: "å°–å°¾ç‰™æ¿ (Pointed)", wire_none: "ç„¡",
                opt_skh9: "SKH-9 (é«˜é€Ÿé‹¼)", opt_ref: "ç¿»ä¿®å“",
                o1: "æ©Ÿç‰™åŠ æ·± (+20%)", o2: "ä¸‰è§’ç‰™/åå…¥å£ (+30%)", o3: "ç‰¹æ®Šç‰™å‹ (+50%)", o4: "ç‰™è·0.4ä»¥ä¸‹ (+15%)",
                o5: "è§’/æ–¹ç‰™ (x2)", o6: "é›™è¦æ ¼ (+30%)", o7: "é›™ç‰™/å·¦ç‰™ (+10%)", o8: "ç‰™å±±30-48åº¦ (+10%)",
                o9: "å››é¢ç”¨ (+50%)", o10: "è¡¨é¢è™•ç† (+15%)", o11: "ç›´é½’42ç‰™+ (+30%)",
                btn: "é€£ç·šè¨ˆç®— (Calculate)", msg_waiting: "ç­‰å¾…è¼¸å…¥...",
                quote_title: "ğŸ“„ å ±åƒ¹å–®å®¢æˆ¶è³‡è¨Š", quote_to: "å®¢æˆ¶åç¨± (To)", quote_attn: "è¯çµ¡äºº (Attn)", quote_tel: "é›»è©± (Tel)", quote_qty: "æ•¸é‡ (Qty)"
            },
            vi: {
                title: "MÃ¡y tÃ­nh BÃ n chÃ  ren", auth: "ğŸ”‘ MÃ£ báº£n quyá»n", thick: "Äá»™ dÃ y (Thickness)", height: "Chiá»u cao (Height)", 
                fixed: "Chiá»u dÃ i cá»‘ Ä‘á»‹nh (Fixed)", moving: "Chiá»u dÃ i di Ä‘á»™ng (Moving)", type: "Loáº¡i (Type)", discount: "Chiáº¿t kháº¥u (Discount)", wire: "PhÃ­ cáº¯t dÃ¢y",
                type_tb: "BÃ n chÃ  ren mÃ¡y (T-B)", type_pt: "BÃ n chÃ  ren mÅ©i nhá»n", wire_none: "KhÃ´ng",
                opt_skh9: "SKH-9 (ThÃ©p giÃ³)", opt_ref: "HÃ ng phá»¥c há»“i",
                o1: "Ren sÃ¢u (+20%)", o2: "Ren tam giÃ¡c (+30%)", o3: "Ren Ä‘áº·c biá»‡t (+50%)", o4: "BÆ°á»›c ren < 0.4 (+15%)",
                o5: "Ren vuÃ´ng (x2)", o6: "Hai quy cÃ¡ch (+30%)", o7: "Ren trÃ¡i/kÃ©p (+10%)", o8: "GÃ³c 30-48 Ä‘á»™ (+10%)",
                o9: "DÃ¹ng 4 máº·t (+50%)", o10: "Xá»­ lÃ½ bá» máº·t (+15%)", o11: "RÄƒng tháº³ng 42+ (+30%)",
                btn: "TÃ­nh toÃ¡n (Calculate)", msg_waiting: "Chá» nháº­p liá»‡u...",
                quote_title: "ğŸ“„ ThÃ´ng tin BÃ¡o GiÃ¡", quote_to: "KhÃ¡ch hÃ ng (To)", quote_attn: "NgÆ°á»i liÃªn há»‡ (Attn)", quote_tel: "Äiá»‡n thoáº¡i (Tel)", quote_qty: "Sá»‘ lÆ°á»£ng (Qty)"
            },
            en: {
                title: "Thread Rolling Die Calculator", auth: "ğŸ”‘ Auth Code", thick: "Thickness", height: "Height", 
                fixed: "Fixed Length", moving: "Moving Length", type: "Type", discount: "Discount", wire: "Wire Cut Fee",
                type_tb: "Machine Die (T-B)", type_pt: "Pointed Tail Die", wire_none: "None",
                opt_skh9: "SKH-9 (High-Speed)", opt_ref: "Refurbished",
                o1: "Deep Thread (+20%)", o2: "Triangle Thread (+30%)", o3: "Special Thread (+50%)", o4: "Pitch < 0.4 (+15%)",
                o5: "Square Thread (x2)", o6: "Dual Specs (+30%)", o7: "Left/Double Thread (+10%)", o8: "Angle 30-48 (+10%)",
                o9: "4-Face Use (+50%)", o10: "Surface Treat (+15%)", o11: "Straight 42+ (+30%)",
                btn: "Calculate", msg_waiting: "Waiting for input...",
                quote_title: "ğŸ“„ Quotation Info", quote_to: "Customer (To)", quote_attn: "Contact (Attn)", quote_tel: "Tel", quote_qty: "Qty"
            }
        };

        window.lastCalcData = null;

        function initApp() {
            changeLanguage();
            changeCurrency();
            populateDiscount();

            const savedToken = localStorage.getItem('threadCalcToken');
            if (savedToken) {
                document.getElementById('auth_token').value = savedToken;
                verifyToken(savedToken); 
            }
        }

        async function verifyToken(token) {
            try {
                const response = await fetch('/api/verify', { method: 'POST', headers: { 'Authorization': token } });
                const result = await response.json();
                const badge = document.getElementById('expiry-badge');
                if (result.success) {
                    badge.style.display = 'block'; badge.innerText = `â³ åˆ°æœŸ: ${result.expireDate}`;
                } else {
                    localStorage.removeItem('threadCalcToken'); badge.style.display = 'none';
                }
            } catch (e) { console.log("é©—è­‰å¤±æ•—"); }
        }

        function changeLanguage() {
            const lang = document.getElementById('lang').value;
            const text = i18n[lang];
            document.getElementById('t_title').innerText = text.title;
            document.getElementById('t_auth').innerText = text.auth;
            document.getElementById('t_thick').innerText = text.thick;
            document.getElementById('t_height').innerText = text.height;
            document.getElementById('t_fixed').innerText = text.fixed;
            document.getElementById('t_moving').innerText = text.moving;
            document.getElementById('t_type').innerText = text.type;
            document.getElementById('t_discount').innerText = text.discount;
            document.getElementById('t_wire').innerText = text.wire;
            document.getElementById('t_type_tb').innerText = text.type_tb;
            document.getElementById('t_type_pt').innerText = text.type_pt;
            document.getElementById('t_wire_none').innerText = text.wire_none;
            document.getElementById('t_opt_skh9').innerText = text.opt_skh9;
            document.getElementById('t_opt_ref').innerText = text.opt_ref;
            for(let i=1; i<=11; i++) { document.getElementById('t_o'+i).innerText = text['o'+i]; }
            document.getElementById('t_btn').innerText = text.btn;
            
            document.getElementById('t_quote_title').innerText = text.quote_title;
            document.getElementById('t_quote_to').innerText = text.quote_to;
            document.getElementById('t_quote_attn').innerText = text.quote_attn;
            document.getElementById('t_quote_tel').innerText = text.quote_tel;
            document.getElementById('t_quote_qty').innerText = text.quote_qty;
            if(document.getElementById('final-price').innerText === "0") { document.getElementById('result-log').innerText = text.msg_waiting; }
        }

        function changeCurrency() {
            const cur = document.getElementById('currency').value;
            document.getElementById('final-currency').innerText = cur;
            const wireSel = document.getElementById('wire');
            if(cur === 'VND') { wireSel.options[1].value = "116000"; wireSel.options[2].value = "231000"; } 
            else { wireSel.options[1].value = "170"; wireSel.options[2].value = "340"; }
        }

        function toggleInput(id) {
            document.getElementById(id).disabled = !document.getElementById(id.replace('val', 'opt')).checked;
        }

        function populateDiscount() {
            const sel = document.getElementById('discount');
            sel.innerHTML = '<option value="10">ç„¡ (None)</option>';
            for (let i = 99; i >= 50; i--) {
                let val = (i / 10).toFixed(1);
                sel.add(new Option(val.endsWith('.0') ? val.substring(0, val.length - 2) + "æŠ˜" : val + "æŠ˜", val));
            }
        }

        async function calculate() {
            const token = document.getElementById('auth_token').value;
            const errorBox = document.getElementById('error-box');
            if(!token) { errorBox.style.display = 'block'; errorBox.innerText = "â›” è«‹è¼¸å…¥ç³»çµ±æˆæ¬Šç¢¼ï¼"; return; }

            const payload = {
                t: parseFloat(document.getElementById('t').value),
                h: parseFloat(document.getElementById('h').value),
                f: parseFloat(document.getElementById('f').value),
                m: parseFloat(document.getElementById('m').value),
                type: document.getElementById('type').value,
                currency: document.getElementById('currency').value,
                wireFee: parseFloat(document.getElementById('wire').value) || 0,
                discount: parseFloat(document.getElementById('discount').value) || 0,
                multipliers: {
                    skh9: parseFloat(document.getElementById('val_skh9').value) || 1.8,
                    refurbish: parseFloat(document.getElementById('val_refurbish').value) || 0.6
                },
                options: {
                    skh9: document.getElementById('opt_skh9').checked,
                    refurbish: document.getElementById('opt_refurbish').checked,
                    shapeX2: document.getElementById('opt_shapeX2').checked,
                    deepen20: document.getElementById('opt_deepen20').checked,
                    reverseTri30: document.getElementById('opt_triangle').checked,
                    complex50: document.getElementById('opt_special50').checked,
                    pitch04: document.getElementById('opt_pitch04').checked,
                    twoSpecs: document.getElementById('opt_twoSpecs').checked,
                    doubleLeft: document.getElementById('opt_doubleLeft').checked,
                    angle3048: document.getElementById('opt_angle3048').checked,
                    faces4: document.getElementById('opt_4faces').checked,
                    surface: document.getElementById('opt_surface').checked,
                    straight42: document.getElementById('opt_straight42').checked
                }
            };

            if (isNaN(payload.t) || isNaN(payload.h) || isNaN(payload.f) || isNaN(payload.m)) {
                errorBox.style.display = 'block'; errorBox.innerText = "è«‹å®Œæ•´å¡«å¯« åšåº¦/é«˜åº¦/å›ºå®šé•·/ç§»å‹•é•·"; return;
            }

            document.getElementById('final-price').innerText = "...";
            document.getElementById('result-log').innerText = "é€£ç·šé©—è­‰ä¸­...";
            errorBox.style.display = 'none';

            try {
                const response = await fetch('/api/calculate', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': token }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('final-price').innerText = result.finalPrice.toLocaleString();
                    document.getElementById('result-log').innerText = result.logs.join('\n');
                    localStorage.setItem('threadCalcToken', token);
                    document.getElementById('expiry-badge').style.display = 'block';
                    document.getElementById('expiry-badge').innerText = `â³ åˆ°æœŸ: ${result.expireDate}`;
                    
                    window.lastCalcData = {
                        t: payload.t, h: payload.h, f: payload.f, m: payload.m,
                        type: payload.type, skh9: payload.options.skh9,
                        unitPrice: result.finalPrice, logs: result.logs, currency: payload.currency
                    };
                } else {
                    errorBox.style.display = 'block'; errorBox.innerText = result.error;
                    document.getElementById('final-price').innerText = "0"; document.getElementById('result-log').innerText = "å¤±æ•—";
                    window.lastCalcData = null;
                }
            } catch (error) {
                errorBox.style.display = 'block'; errorBox.innerText = "ä¼ºæœå™¨é€£ç·šå¤±æ•—"; window.lastCalcData = null;
            }
        }

        function getQuoteDetails() {
            if (!window.lastCalcData) { alert("è«‹å…ˆé€²è¡Œè¨ˆç®—å¾Œå†åŒ¯å‡ºå ±åƒ¹å–®ï¼"); return null; }
            const d = window.lastCalcData;
            return {
                d: d,
                custName: document.getElementById('cust_name').value || 'æœªå¡«å¯«å®¢æˆ¶',
                custAttn: document.getElementById('cust_attn').value || '',
                custTel: document.getElementById('cust_tel').value || '',
                qty: parseInt(document.getElementById('qty').value) || 1,
                dateStr: new Date().toISOString().split('T')[0].replace(/-/g, '/'),
                specStr: `ç‰™æ¿-BÃ€N CÃN\n${d.type === 'Pointed' ? 'å°–å°¾' : 'æ©Ÿæ¢°'} ${d.t}*${d.h}*${d.f}/${d.m}`,
                material: d.skh9 ? 'SKH-9' : 'H9',
                currency: d.currency
            };
        }

        async function exportExcel() {
            try {
                if (typeof ExcelJS === 'undefined') { alert("Excelå¥—ä»¶å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); return; }
                const quote = getQuoteDetails(); if (!quote) return;

                const workbook = new ExcelJS.Workbook();
                const ws = workbook.addWorksheet('BÃ¡o GiÃ¡');

                const ws_data = [
                    ["", "ç²¾æ–Œè²¬ä»»æœ‰é™å…¬å¸", "", "", "", "", "", "", ""],
                    ["", "CÃ”NG TY TNHH Há»¢P KIM BÆ¯á»šC NHáº¢Y", "", "", "", "", "", "", ""],
                    ["", "                  Ä/C:  LÃ´ CN14, Ã” Sá»‘ 16, ÄÆ°á»ng sá»‘ 4, KCN SÃ³ng Tháº§n 3, PhÆ°á»ng BÃ¬nh DÆ°Æ¡ng, TP.Há»“ ChÃ­ Minh", "", "", "", "", "", "", ""],
                    ["", "Tel: 0274-3669503-4                  Fax : 0274 - 3557129", "", "", "", "", "", "", ""],
                    ["", "", "", "", "", "", "", "", ""],
                    ["", "To   : " + quote.custName, "", "", "", "", "", "", ""],
                    ["", "Attn : " + quote.custAttn, "", "", "", "", "", "", ""],
                    ["", "Tel   : " + quote.custTel, "", "", "", "", "", "", ""],
                    ["å ±åƒ¹å–®", "", "", "", "", "", "", "", ""], // æ©«è·¨æ•´åˆ—ç½®ä¸­
                    ["Báº¢NG BÃO GIÃ", "", "", "", "", "", "", "", ""], // æ©«è·¨æ•´åˆ—ç½®ä¸­
                    ["", "", "", "", "", "", "", "æ—¥æœŸ/ngÃ y thÃ¡ngï¼š" + quote.dateStr, ""],
                    ["STT\nåºè™Ÿ", "TÃªn sáº£n pháº©m / Quy cÃ¡ch \nå“å/å°ºå¯¸", "", "Ävt\nå–®ä½", "Cháº¥t Liá»‡u\næè³ª", "æ•¸é‡", `å–®åƒ¹\n(${quote.currency})`, `é‡‘é¡\n(${quote.currency})`, "Ghi chÃº\nå‚™è¨»"],
                    // âœ… å‚™è¨»æ¬„ä½å®Œå…¨ç•™ç™½ ("") ä¸é¡¯ç¤ºè¨ˆç®— log
                    [1.0, quote.specStr, "", "ç»„", quote.material, quote.qty, quote.d.unitPrice, quote.d.unitPrice * quote.qty, ""], 
                    // âœ… æ–°å¢çš„ Total ç¸½åƒ¹åˆ—
                    ["Tá»•ng cá»™ng / ç¸½è¨ˆï¼š", "", "", "", "", "", "", quote.d.unitPrice * quote.qty, ""], 
                    ["", "", "", "", "", "", "", "", ""],
                    ["", "1. ÄÆ¡n giÃ¡ trÃªn chÆ°a bao gá»“m thuáº¿ VAT.", "", "", "", "", "", "", ""],
                    ["", "   ä»¥ä¸Šçš„åƒ¹æ ¼ä¸å«ç¨…ã€‚", "", "", "", "", "", "", ""],
                    ["", "2. PhÆ°Æ¡ng Thá»©c thanh toÃ¡n.", "", "", "", "", "", "", ""],
                    ["", "   ä»˜æ¬¾æ–¹å¼ã€‚", "", "", "", "", "", "", ""],
                    ["", "   ï¼ˆ ï¼‰ç…§ä¹°å–åˆåŒ", "", "ï¼ˆ ï¼‰é“¶è¡Œæ±‡æ¬¾", "", "", "ï¼ˆ ï¼‰ç°é‡‘", "", ""],
                    ["", "   Theo há»£p dá»“ng kinh táº¿", "", "chuyá»ƒn khoáº£n", "", "", "tiá»n máº·t", "", ""],
                    ["", "", "", "", "", "", "", "", ""],
                    ["", "KhÃ¡ch HÃ ng XÃ¡c Nháº­n", "", "", "", "CÃ”NG TY TNHH Há»¢P KIM BÆ¯á»šC NHáº¢Y", "", "", ""],
                    ["", "å®¢æˆ¶ç¢ºèª", "", "", "", "ç²¾æ–Œè²¬ä»»æœ‰é™å…¬å¸", "", "", ""]
                ];

                ws_data.forEach(row => ws.addRow(row));

                // âš ï¸ è«‹åœ¨é€™è£¡æ›¿æ›æˆæ‚¨ç”¨å·¥å…·è½‰æ›å‡ºä¾†çš„ Base64 åœ–ç‰‡ç·¨ç¢¼ï¼
                const logoBase64 = 'data:image/png;base64,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'; 
                
                const imageId = workbook.addImage({
                    base64: logoBase64,
                    extension: 'png',
                });
                
                ws.addImage(imageId, {
                    tl: { col: 0, row: 0 },
                    br: { col: 1, row: 4 },
                    editAs: 'oneCell'
                });

                // âœ… æ”¾å¤§æ‰€æœ‰æ¬„ä½çš„å¯¬åº¦
                ws.getColumn(1).width = 14; // A
                ws.getColumn(2).width = 30; // B
                ws.getColumn(3).width = 5;  // C
                ws.getColumn(4).width = 18; // D
                ws.getColumn(5).width = 16; // E
                ws.getColumn(6).width = 12; // F
                ws.getColumn(7).width = 20; // G
                ws.getColumn(8).width = 20; // H
                ws.getColumn(9).width = 40; // I

                // âœ… èª¿æ•´æ¯åˆ—çš„è¡Œé«˜ï¼Œè®“æ’ç‰ˆæ›´å¤§æ°£
                ws.eachRow((row) => { row.height = 25; }); // åŸºç¤é«˜åº¦
                ws.getRow(1).height = 30; // é…åˆ JP å•†æ¨™
                ws.getRow(9).height = 35; // å ±åƒ¹å–®æ¨™é¡Œ
                ws.getRow(10).height = 35;
                ws.getRow(12).height = 40; // æ¬„ä½è¡¨é ­
                ws.getRow(13).height = 80; // å“åèˆ‡å°ºå¯¸ (å¤šè¡Œæ–‡å­—)
                ws.getRow(14).height = 35; // Total ç¸½è¨ˆåˆ—

                ws.mergeCells('B1:I1'); 
                ws.mergeCells('B2:I2'); 
                ws.mergeCells('B3:I3'); 
                ws.mergeCells('B4:I4'); 
                ws.mergeCells('B6:D6'); 
                ws.mergeCells('B7:D7'); 
                ws.mergeCells('B8:D8'); 
                
                // âœ… å°‡å ±åƒ¹å–®æ¨™é¡Œæ©«è·¨ A åˆ° I æ¬„åˆä½µï¼Œé”æˆå®Œç¾ç½®ä¸­
                ws.mergeCells('A9:I9');
                ws.mergeCells('A10:I10');
                
                ws.mergeCells('B12:C12'); 
                ws.mergeCells('B13:C13'); 
                ws.mergeCells('A14:G14'); // å°‡ Total ç¸½è¨ˆæ–‡å­—è·¨æ¬„åˆä½µ
                
                ws.mergeCells('B23:D23'); 
                ws.mergeCells('B24:D24'); 
                ws.mergeCells('F23:I23'); 
                ws.mergeCells('F24:I24'); 

                // âœ… æ”¾å®‰å…¨å±€å­—é«”å¤§å°è‡³ 12 (åŸæœ¬æ˜¯ 11)
                ws.eachRow((row) => {
                    row.eachCell((cell) => {
                        cell.font = { name: "Arial", size: 12 };
                    });
                });

                // âœ… ç‚ºè¡¨é ­ã€è³‡æ–™åˆ—ã€èˆ‡ç¸½è¨ˆåˆ—åŠ ä¸Šå¤–æ¡†èˆ‡ç½®ä¸­
                ['A12','B12','C12','D12','E12','F12','G12','H12','I12',
                 'A13','B13','C13','D13','E13','F13','G13','H13','I13',
                 'A14','B14','C14','D14','E14','F14','G14','H14','I14'].forEach(cellRef => {
                    const cell = ws.getCell(cellRef);
                    cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                    cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                });

                // âœ… é‡‘é¡åŠ ä¸Šåƒåˆ†ä½é€—è™Ÿæ ¼å¼
                const numFormat = quote.currency === 'USD' ? '#,##0.00' : '#,##0';
                ws.getCell('G13').numFmt = numFormat;
                ws.getCell('H13').numFmt = numFormat;
                ws.getCell('H14').numFmt = numFormat;

                ws.getCell('B1').font = { name: "Arial", size: 15, bold: true };
                ws.getCell('B2').font = { name: "Arial", size: 13, bold: true };
                
                // âœ… æ¨™é¡Œç½®ä¸­æ¨£å¼
                ws.getCell('A9').font = { name: "Arial", size: 18, bold: true };
                ws.getCell('A9').alignment = { horizontal: "center", vertical: "middle" };
                ws.getCell('A10').font = { name: "Arial", size: 16, bold: true };
                ws.getCell('A10').alignment = { horizontal: "center", vertical: "middle" };
                
                // âœ… å“åå‚™è¨»é å·¦ã€Total ç½®å³
                ws.getCell('B13').alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
                ws.getCell('I13').alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
                ws.getCell('A14').alignment = { vertical: 'middle', horizontal: 'right', indent: 1 };
                ws.getCell('A14').font = { name: "Arial", size: 13, bold: true };
                ws.getCell('H14').font = { name: "Arial", size: 13, bold: true };

                ws.getCell('B23').alignment = { horizontal: "center" };
                ws.getCell('B24').alignment = { horizontal: "center" };
                ws.getCell('F23').alignment = { horizontal: "center" };
                ws.getCell('F24').alignment = { horizontal: "center" };

                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), `å ±åƒ¹å–®_${quote.custName}_${quote.dateStr.replace(/\//g, '')}.xlsx`);

            } catch (err) { alert("Excel åŒ¯å‡ºç™¼ç”ŸéŒ¯èª¤: " + err.message); console.error(err); }
        }

        initApp();
    </script>
</body>
</html>