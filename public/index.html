<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰™æ¿å ±åƒ¹è¨ˆç®—å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; background-color: #f2f2f7; padding: 15px; padding-bottom: 100px; color: #333; margin: 0; }
        .container { position: relative; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); max-width: 800px; margin: 0 auto; }
        h2 { text-align: center; color: #333; margin-bottom: 15px; font-weight: 700; margin-top: 5px; }
        
        #expiry-badge { position: absolute; top: 15px; right: 15px; z-index: 99; font-size: 0.75rem; background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 12px; display: none; font-weight: bold; border: 1px solid #c8e6c9; }

        .top-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .top-controls select { padding: 10px; font-size: 15px; border-radius: 8px; background-color: #f8f9fa; border: 1px solid #ccc; }
        
        .auth-group { background: #e1f5fe; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #b3e5fc; }
        .form-group { margin-bottom: 15px; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; color: #555; }
        
        select, input[type="number"], input[type="text"], input[type="password"] { width: 100%; padding: 14px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; background-color: #fff; box-sizing: border-box; appearance: none; -webkit-appearance: none; }
        select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; }
        input:focus, select:focus { border-color: #007aff; outline: none; }
        
        .var-section { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .var-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .var-input { width: 80px !important; padding: 8px !important; text-align: center; color: #d35400; font-weight: bold; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .check-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; padding: 2px; }
        .check-item input { width: 20px; height: 20px; accent-color: #007aff; }
        
        .btn-calc { width: 100%; background-color: #007aff; color: white; font-size: 1.2rem; font-weight: bold; padding: 16px; border: none; border-radius: 12px; margin-top: 25px; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3); cursor: pointer; }
        .btn-calc:active { transform: scale(0.98); background-color: #0062cc; }
        
        .result-box { background: #1c1c1e; color: white; padding: 25px; border-radius: 15px; margin-top: 25px; text-align: center; }
        .price-container { display: flex; justify-content: center; align-items: baseline; gap: 5px; }
        .price-val { font-size: 2.5rem; font-weight: 800; color: #30d158; line-height: 1.2; }
        .currency-unit { font-size: 1.2rem; color: #8e8e93; font-weight: 600; }
        #result-log { font-size: 0.85rem; margin-top: 15px; color: #aaa; text-align: left; white-space: pre-line; line-height: 1.5; border-top: 1px solid #333; padding-top: 15px; }
        .error-msg { background: #ffebee; color: #c62828; padding: 12px; border-radius: 8px; margin-top: 15px; display: none; font-weight: bold; text-align: center; font-size: 0.95rem; }
        
        /* å ±åƒ¹å–®è³‡è¨Šå€å¡Šæ¨£å¼ (ç§»è‡³æœ€ä¸‹æ–¹) */
        .quote-info-box { background: #e8f5e9; padding: 20px; border-radius: 12px; margin-top: 30px; border: 1px solid #c8e6c9; }
        .quote-info-box label { color: #2e7d32; font-size: 0.9rem; }
        .quote-title { font-weight: bold; font-size: 1.1rem; color: #1b5e20; margin-bottom: 15px; text-align: center; border-bottom: 2px solid #a5d6a7; padding-bottom: 10px; }
        
        .export-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-export { width: 100%; color: white; font-weight: bold; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-excel { background-color: #27ae60; }
        .btn-pdf { background-color: #e74c3c; }

        .copyright { text-align: center; margin-top: 30px; font-size: 0.8rem; color: #8e8e93; }
    </style>
</head>
<body>

    <div class="container">
        <div id="expiry-badge">â³ é©—è­‰ä¸­...</div>

        <h2 id="t_title">æ“ç‰™æ¿è¨ˆç®—å™¨</h2>

        <div class="top-controls">
            <select id="lang" onchange="changeLanguage()">
                <option value="zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ (ç¹é«”)</option>
                <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                <option value="en">ğŸ‡ºğŸ‡¸ English</option>
            </select>
            <select id="currency" onchange="changeCurrency()">
                <option value="TWD">NT$ å°å¹£ (TWD)</option>
                <option value="VND">â‚« è¶Šç›¾ (VND)</option>
                <option value="USD">$ ç¾é‡‘ (USD)</option>
            </select>
        </div>

        <div class="form-group auth-group">
            <label id="t_auth" style="color: #0277bd;">ğŸ”‘ ç³»çµ±æˆæ¬Šç¢¼ (Auth Code)</label>
            <input type="password" id="auth_token" placeholder="VIP888" style="border: 1px solid #0288d1;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label id="t_thick">åšåº¦ (Thickness)</label>
                <input type="number" id="t" placeholder="25" step="0.1">
            </div>
            <div class="form-group">
                <label id="t_height">é«˜åº¦ (Height)</label>
                <input type="number" id="h" placeholder="30" step="0.1">
            </div>
            <div class="form-group">
                <label id="t_fixed">å›ºå®šé•· (Fixed)</label>
                <input type="number" id="f" placeholder="76" step="0.1">
            </div>
            <div class="form-group">
                <label id="t_moving">ç§»å‹•é•· (Moving)</label>
                <input type="number" id="m" placeholder="89" step="0.1">
            </div>
        </div>

        <div class="form-group full-width">
            <label id="t_type">é¡åˆ¥ (Type)</label>
            <select id="type">
                <option value="TB" id="t_type_tb">æ©Ÿæ¢°ç‰™æ¿ (Machine / T-B)</option>
                <option value="Pointed" id="t_type_pt">å°–å°¾ç‰™æ¿ (Pointed Tail)</option>
            </select>
        </div>

        <div class="form-group">
            <label id="t_discount" style="color:#ff3b30;">æŠ˜æ‰£ (Discount)</label>
            <select id="discount"></select>
        </div>

        <div class="form-group" id="wire-fee-box" style="padding:10px; border:1px dashed #999; border-radius:8px;">
            <label id="t_wire">ç·šå‰²è²» (Wire Cut)</label>
            <select id="wire">
                <option value="0" id="t_wire_none">ç„¡ (None)</option>
                <option value="116000">JP ç‰™æ¿ (116,000 VND / 170 TWD)</option>
                <option value="231000">é JP (231,000 VND / 340 TWD)</option>
            </select>
        </div>

        <div class="var-section">
            <div class="var-row">
                <label class="check-item"><input type="checkbox" id="opt_skh9" onchange="toggleInput('val_skh9')"> <span id="t_opt_skh9">SKH-9 (é«˜é€Ÿé‹¼)</span></label>
                <div class="var-input-group">
                    x <input type="number" id="val_skh9" class="var-input" value="1.8" step="0.1" disabled>
                </div>
            </div>
            <div class="var-row">
                <label class="check-item"><input type="checkbox" id="opt_refurbish" onchange="toggleInput('val_refurbish')"> <span id="t_opt_ref">ç¿»ä¿®å“ (Refurbish)</span></label>
                <div class="var-input-group">
                    x <input type="number" id="val_refurbish" class="var-input" value="0.6" step="0.1" disabled>
                </div>
            </div>
        </div>

        <div class="options-grid">
            <label class="check-item"><input type="checkbox" id="opt_deepen20"> <span id="t_o1">æ©Ÿç‰™åŠ æ·± (+20%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_triangle"> <span id="t_o2">ä¸‰è§’ç‰™/åå…¥å£ (+30%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_special50"> <span id="t_o3">ç‰¹æ®Šç‰™å‹ (+50%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_pitch04"> <span id="t_o4">ç‰™è·0.4ä»¥ä¸‹ (+15%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_shapeX2"> <span id="t_o5">è§’/æ–¹ç‰™ (x2)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_twoSpecs"> <span id="t_o6">é›™è¦æ ¼ (+30%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_doubleLeft"> <span id="t_o7">é›™ç‰™/å·¦ç‰™ (+10%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_angle3048"> <span id="t_o8">ç‰™å±±30-48åº¦ (+10%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_4faces"> <span id="t_o9">å››é¢ç”¨ (+50%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_surface"> <span id="t_o10">è¡¨é¢è™•ç† (+15%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_straight42"> <span id="t_o11">ç›´é½’42ç‰™+ (+30%)</span></label>
        </div>

        <button class="btn-calc" onclick="calculate()" id="t_btn">é€£ç·šè¨ˆç®— (Calculate)</button>
        <div id="error-box" class="error-msg"></div>

        <div class="result-box">
            <div class="price-container">
                <span class="price-val" id="final-price">0</span>
                <span class="currency-unit" id="final-currency">TWD</span>
            </div>
            <div id="result-log"></div>
        </div>

        <div class="quote-info-box">
            <div class="quote-title" id="t_quote_title">ğŸ“„ å ±åƒ¹å–®å®¢æˆ¶è³‡è¨Š (Quotation Info)</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group"><label id="t_quote_to">å®¢æˆ¶åç¨± (To)</label><input type="text" id="cust_name" placeholder="è¯åˆå…¬å¸"></div>
                <div class="form-group"><label id="t_quote_attn">è¯çµ¡äºº (Attn)</label><input type="text" id="cust_attn" placeholder="é™³å…ˆç”Ÿ"></div>
                <div class="form-group"><label id="t_quote_tel">é›»è©± (Tel)</label><input type="text" id="cust_tel" placeholder="0868 549 896"></div>
                <div class="form-group"><label id="t_quote_qty">æ•¸é‡ (Qty)</label><input type="number" id="qty" value="1" min="1"></div>
            </div>
            <div class="export-btns">
                <button class="btn-export btn-excel" onclick="exportExcel()">â¬‡ï¸ åŒ¯å‡º Excel</button>
                <button class="btn-export btn-pdf" onclick="exportPDF()">â¬‡ï¸ åŒ¯å‡º PDF</button>
            </div>
        </div>

        <div class="copyright">Â© è¬æ™ºç¿” u9511112@gmail.com</div>
    </div>

    <script>
        // å¤šåœ‹èªè¨€å­—å…¸
        const i18n = {
            zh: {
                title: "æ“ç‰™æ¿è¨ˆç®—å™¨", auth: "ğŸ”‘ ç³»çµ±æˆæ¬Šç¢¼", thick: "åšåº¦ (Thickness)", height: "é«˜åº¦ (Height)", 
                fixed: "å›ºå®šé•· (Fixed)", moving: "ç§»å‹•é•· (Moving)", type: "é¡åˆ¥ (Type)", discount: "æŠ˜æ‰£ (Discount)", wire: "ç·šå‰²è²» (Wire Cut)",
                type_tb: "æ©Ÿæ¢°ç‰™æ¿ (T-B)", type_pt: "å°–å°¾ç‰™æ¿ (Pointed)", wire_none: "ç„¡",
                opt_skh9: "SKH-9 (é«˜é€Ÿé‹¼)", opt_ref: "ç¿»ä¿®å“",
                o1: "æ©Ÿç‰™åŠ æ·± (+20%)", o2: "ä¸‰è§’ç‰™/åå…¥å£ (+30%)", o3: "ç‰¹æ®Šç‰™å‹ (+50%)", o4: "ç‰™è·0.4ä»¥ä¸‹ (+15%)",
                o5: "è§’/æ–¹ç‰™ (x2)", o6: "é›™è¦æ ¼ (+30%)", o7: "é›™ç‰™/å·¦ç‰™ (+10%)", o8: "ç‰™å±±30-48åº¦ (+10%)",
                o9: "å››é¢ç”¨ (+50%)", o10: "è¡¨é¢è™•ç† (+15%)", o11: "ç›´é½’42ç‰™+ (+30%)",
                btn: "é€£ç·šè¨ˆç®— (Calculate)", msg_waiting: "ç­‰å¾…è¼¸å…¥...",
                quote_title: "ğŸ“„ å ±åƒ¹å–®å®¢æˆ¶è³‡è¨Š", quote_to: "å®¢æˆ¶åç¨± (To)", quote_attn: "è¯çµ¡äºº (Attn)", quote_tel: "é›»è©± (Tel)", quote_qty: "æ•¸é‡ (Qty)"
            },
            vi: {
                title: "MÃ¡y tÃ­nh BÃ n chÃ  ren", auth: "ğŸ”‘ MÃ£ báº£n quyá»n", thick: "Äá»™ dÃ y (Thickness)", height: "Chiá»u cao (Height)", 
                fixed: "Chiá»u dÃ i cá»‘ Ä‘á»‹nh (Fixed)", moving: "Chiá»u dÃ i di Ä‘á»™ng (Moving)", type: "Loáº¡i (Type)", discount: "Chiáº¿t kháº¥u (Discount)", wire: "PhÃ­ cáº¯t dÃ¢y",
                type_tb: "BÃ n chÃ  ren mÃ¡y (T-B)", type_pt: "BÃ n chÃ  ren mÅ©i nhá»n", wire_none: "KhÃ´ng",
                opt_skh9: "SKH-9 (ThÃ©p giÃ³)", opt_ref: "HÃ ng phá»¥c há»“i",
                o1: "Ren sÃ¢u (+20%)", o2: "Ren tam giÃ¡c (+30%)", o3: "Ren Ä‘áº·c biá»‡t (+50%)", o4: "BÆ°á»›c ren < 0.4 (+15%)",
                o5: "Ren vuÃ´ng (x2)", o6: "Hai quy cÃ¡ch (+30%)", o7: "Ren trÃ¡i/kÃ©p (+10%)", o8: "GÃ³c 30-48 Ä‘á»™ (+10%)",
                o9: "DÃ¹ng 4 máº·t (+50%)", o10: "Xá»­ lÃ½ bá» máº·t (+15%)", o11: "RÄƒng tháº³ng 42+ (+30%)",
                btn: "TÃ­nh toÃ¡n (Calculate)", msg_waiting: "Chá» nháº­p liá»‡u...",
                quote_title: "ğŸ“„ ThÃ´ng tin BÃ¡o GiÃ¡", quote_to: "KhÃ¡ch hÃ ng (To)", quote_attn: "NgÆ°á»i liÃªn há»‡ (Attn)", quote_tel: "Äiá»‡n thoáº¡i (Tel)", quote_qty: "Sá»‘ lÆ°á»£ng (Qty)"
            },
            en: {
                title: "Thread Rolling Die Calculator", auth: "ğŸ”‘ Auth Code", thick: "Thickness", height: "Height", 
                fixed: "Fixed Length", moving: "Moving Length", type: "Type", discount: "Discount", wire: "Wire Cut Fee",
                type_tb: "Machine Die (T-B)", type_pt: "Pointed Tail Die", wire_none: "None",
                opt_skh9: "SKH-9 (High-Speed)", opt_ref: "Refurbished",
                o1: "Deep Thread (+20%)", o2: "Triangle Thread (+30%)", o3: "Special Thread (+50%)", o4: "Pitch < 0.4 (+15%)",
                o5: "Square Thread (x2)", o6: "Dual Specs (+30%)", o7: "Left/Double Thread (+10%)", o8: "Angle 30-48 (+10%)",
                o9: "4-Face Use (+50%)", o10: "Surface Treat (+15%)", o11: "Straight 42+ (+30%)",
                btn: "Calculate", msg_waiting: "Waiting for input...",
                quote_title: "ğŸ“„ Quotation Info", quote_to: "Customer (To)", quote_attn: "Contact (Attn)", quote_tel: "Tel", quote_qty: "Qty"
            }
        };

        window.lastCalcData = null;

        function initApp() {
            changeLanguage();
            changeCurrency();
            populateDiscount();

            const savedToken = localStorage.getItem('threadCalcToken');
            if (savedToken) {
                document.getElementById('auth_token').value = savedToken;
                verifyToken(savedToken); 
            }
        }

        async function verifyToken(token) {
            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Authorization': token }
                });
                const result = await response.json();
                const badge = document.getElementById('expiry-badge');
                
                if (result.success) {
                    badge.style.display = 'block';
                    badge.innerText = `â³ åˆ°æœŸ: ${result.expireDate}`;
                } else {
                    localStorage.removeItem('threadCalcToken');
                    badge.style.display = 'none';
                }
            } catch (e) { console.log("ç„¡æ³•è‡ªå‹•é©—è­‰"); }
        }

        function changeLanguage() {
            const lang = document.getElementById('lang').value;
            const text = i18n[lang];
            
            document.getElementById('t_title').innerText = text.title;
            document.getElementById('t_auth').innerText = text.auth;
            document.getElementById('t_thick').innerText = text.thick;
            document.getElementById('t_height').innerText = text.height;
            document.getElementById('t_fixed').innerText = text.fixed;
            document.getElementById('t_moving').innerText = text.moving;
            document.getElementById('t_type').innerText = text.type;
            document.getElementById('t_discount').innerText = text.discount;
            document.getElementById('t_wire').innerText = text.wire;
            
            document.getElementById('t_type_tb').innerText = text.type_tb;
            document.getElementById('t_type_pt').innerText = text.type_pt;
            document.getElementById('t_wire_none').innerText = text.wire_none;
            
            document.getElementById('t_opt_skh9').innerText = text.opt_skh9;
            document.getElementById('t_opt_ref').innerText = text.opt_ref;
            for(let i=1; i<=11; i++) { document.getElementById('t_o'+i).innerText = text['o'+i]; }
            
            document.getElementById('t_btn').innerText = text.btn;
            
            // å ±åƒ¹å–®ç¿»è­¯
            document.getElementById('t_quote_title').innerText = text.quote_title;
            document.getElementById('t_quote_to').innerText = text.quote_to;
            document.getElementById('t_quote_attn').innerText = text.quote_attn;
            document.getElementById('t_quote_tel').innerText = text.quote_tel;
            document.getElementById('t_quote_qty').innerText = text.quote_qty;

            if(document.getElementById('final-price').innerText === "0") {
                document.getElementById('result-log').innerText = text.msg_waiting;
            }
        }

        function changeCurrency() {
            const cur = document.getElementById('currency').value;
            document.getElementById('final-currency').innerText = cur;
            
            const wireSel = document.getElementById('wire');
            if(cur === 'VND') {
                wireSel.options[1].value = "116000"; wireSel.options[2].value = "231000";
            } else if (cur === 'TWD' || cur === 'USD') {
                wireSel.options[1].value = "170"; wireSel.options[2].value = "340";
            }
        }

        function toggleInput(id) {
            const checkbox = document.getElementById(id.replace('val', 'opt'));
            document.getElementById(id).disabled = !checkbox.checked;
        }

        function populateDiscount() {
            const sel = document.getElementById('discount');
            sel.innerHTML = '<option value="10">ç„¡ (None)</option>';
            for (let i = 99; i >= 50; i--) {
                let val = (i / 10).toFixed(1);
                sel.add(new Option(val.endsWith('.0') ? val.substring(0, val.length - 2) + "æŠ˜" : val + "æŠ˜", val));
            }
        }

        async function calculate() {
            const token = document.getElementById('auth_token').value;
            const errorBox = document.getElementById('error-box');
            const priceDisplay = document.getElementById('final-price');
            const logArea = document.getElementById('result-log');

            if(!token) { errorBox.style.display = 'block'; errorBox.innerText = "â›” è«‹å…ˆè¼¸å…¥ä¸Šæ–¹çš„ç³»çµ±æˆæ¬Šç¢¼ï¼"; return; }

            const payload = {
                t: parseFloat(document.getElementById('t').value),
                h: parseFloat(document.getElementById('h').value),
                f: parseFloat(document.getElementById('f').value),
                m: parseFloat(document.getElementById('m').value),
                type: document.getElementById('type').value,
                currency: document.getElementById('currency').value,
                wireFee: parseFloat(document.getElementById('wire').value) || 0,
                discount: parseFloat(document.getElementById('discount').value) || 0,
                
                multipliers: {
                    skh9: parseFloat(document.getElementById('val_skh9').value) || 1.8,
                    refurbish: parseFloat(document.getElementById('val_refurbish').value) || 0.6
                },
                
                options: {
                    skh9: document.getElementById('opt_skh9').checked,
                    refurbish: document.getElementById('opt_refurbish').checked,
                    shapeX2: document.getElementById('opt_shapeX2').checked,
                    deepen20: document.getElementById('opt_deepen20').checked,
                    reverseTri30: document.getElementById('opt_triangle').checked,
                    complex50: document.getElementById('opt_special50').checked,
                    pitch04: document.getElementById('opt_pitch04').checked,
                    twoSpecs: document.getElementById('opt_twoSpecs').checked,
                    doubleLeft: document.getElementById('opt_doubleLeft').checked,
                    angle3048: document.getElementById('opt_angle3048').checked,
                    faces4: document.getElementById('opt_4faces').checked,
                    surface: document.getElementById('opt_surface').checked,
                    straight42: document.getElementById('opt_straight42').checked
                }
            };

            if (isNaN(payload.t) || isNaN(payload.h) || isNaN(payload.f) || isNaN(payload.m)) {
                errorBox.style.display = 'block'; errorBox.innerText = "è«‹å¡«å¯«æ‰€æœ‰è¦æ ¼ (åšåº¦, é«˜åº¦, å›ºå®šé•·, ç§»å‹•é•·)"; return;
            }

            priceDisplay.innerText = "...";
            logArea.innerText = "ğŸ“¡ æ­£åœ¨é€£ç·šè‡³é›²ç«¯ä¼ºæœå™¨é©—è­‰æˆæ¬Š...";
            errorBox.style.display = 'none';

            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (result.success) {
                    priceDisplay.innerText = result.finalPrice.toLocaleString();
                    logArea.innerText = result.logs.join('\n');
                    
                    localStorage.setItem('threadCalcToken', token);
                    const badge = document.getElementById('expiry-badge');
                    badge.style.display = 'block';
                    badge.innerText = `â³ åˆ°æœŸ: ${result.expireDate}`;
                    
                    window.lastCalcData = {
                        t: payload.t, h: payload.h, f: payload.f, m: payload.m,
                        type: payload.type, skh9: payload.options.skh9,
                        unitPrice: result.finalPrice, logs: result.logs, currency: payload.currency
                    };
                } else {
                    errorBox.style.display = 'block'; errorBox.innerText = result.error;
                    priceDisplay.innerText = "0"; logArea.innerText = "è¨ˆç®—å¤±æ•—";
                    window.lastCalcData = null;
                }
            } catch (error) {
                errorBox.style.display = 'block'; errorBox.innerText = "ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹ã€‚";
                window.lastCalcData = null;
            }
        }

        function getQuoteDetails() {
            if (!window.lastCalcData) {
                alert("è«‹å…ˆæˆåŠŸé€²è¡Œä¸€æ¬¡ã€Œé€£ç·šè¨ˆç®—ã€å¾Œï¼Œå†åŒ¯å‡ºå ±åƒ¹å–®ï¼");
                return null;
            }
            const d = window.lastCalcData;
            const typeLabel = d.type === 'Pointed' ? 'å°–å°¾ç‰™æ¿' : 'æ©Ÿæ¢°ç‰™æ¿';
            const materialLabel = d.skh9 ? 'SKH-9' : 'H9';
            return {
                d: d,
                custName: document.getElementById('cust_name').value || 'æœªå¡«å¯«å®¢æˆ¶',
                custAttn: document.getElementById('cust_attn').value || '',
                custTel: document.getElementById('cust_tel').value || '',
                qty: parseInt(document.getElementById('qty').value) || 1,
                dateStr: new Date().toISOString().split('T')[0].replace(/-/g, '/'),
                specStr: `ç‰™æ¿-BÃ€N CÃN\n${typeLabel}\n${d.t}*${d.h}*${d.f}/${d.m}`,
                material: materialLabel,
                currency: d.currency
            };
        }

        function exportExcel() {
            const quote = getQuoteDetails();
            if (!quote) return;

            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["ç²¾æ–Œè²¬ä»»æœ‰é™å…¬å¸"],
                ["CÃ”NG TY TNHH Há»¢P KIM BÆ¯á»šC NHáº¢Y"],
                ["Ä/C: LÃ´ CN14, Ã” Sá»‘ 16, ÄÆ°á»ng sá»‘ 4, KCN SÃ³ng Tháº§n 3, PhÆ°á»ng BÃ¬nh DÆ°Æ¡ng, TP.Há»“ ChÃ­ Minh"],
                ["Tel: 0274-3669503-4", "", "", "Fax : 0274 - 3557129"],
                [],
                ["To   :", quote.custName],
                ["Attn :", quote.custAttn],
                ["Tel  :", quote.custTel],
                [],
                ["", "", "", "å ±åƒ¹å–®"],
                ["", "", "", "Báº¢NG BÃO GIÃ"],
                [],
                ["", "", "", "", "", "", "æ—¥æœŸ/ngÃ y thÃ¡ngï¼š" + quote.dateStr],
                ["STT\nåºè™Ÿ", "TÃªn sáº£n pháº©m / Quy cÃ¡ch \nå“å/å°ºå¯¸", "", "Ävt\nå–®ä½", "Cháº¥t Liá»‡u\næè³ª", "æ•¸é‡", `å–®åƒ¹\n(${quote.currency})`, `é‡‘é¡\n(${quote.currency})`, "Ghi chÃº\nå‚™è¨»"],
                [1, quote.specStr, "", "ç»„", quote.material, quote.qty, quote.d.unitPrice, quote.d.unitPrice * quote.qty, quote.d.logs.join('\n')]
            ];

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "BÃ¡o GiÃ¡");
            XLSX.writeFile(wb, `å ±åƒ¹å–®_${quote.custName}_${quote.dateStr.replace(/\//g, '')}.xlsx`);
        }

        function exportPDF() {
            const quote = getQuoteDetails();
            if (!quote) return;

            const element = document.createElement('div');
            element.innerHTML = `
                <div style="padding: 40px; font-family: sans-serif; color: #000; background: #fff; line-height: 1.5;">
                    <h3 style="margin:0;">ç²¾æ–Œè²¬ä»»æœ‰é™å…¬å¸</h3>
                    <h4 style="margin:0;">CÃ”NG TY TNHH Há»¢P KIM BÆ¯á»šC NHáº¢Y</h4>
                    <p style="font-size: 13px; margin: 8px 0;">Ä/C: LÃ´ CN14, Ã” Sá»‘ 16, ÄÆ°á»ng sá»‘ 4, KCN SÃ³ng Tháº§n 3, PhÆ°á»ng BÃ¬nh DÆ°Æ¡ng, TP.Há»“ ChÃ­ Minh</p>
                    <p style="font-size: 13px; margin: 0 0 30px 0;">Tel: 0274-3669503-4 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Fax : 0274 - 3557129</p>
                    
                    <table style="width: 100%; border: none; font-size: 15px; margin-bottom: 20px;">
                        <tr><td style="width: 80px; font-weight:bold;">To:</td><td>${quote.custName}</td></tr>
                        <tr><td style="font-weight:bold;">Attn:</td><td>${quote.custAttn}</td></tr>
                        <tr><td style="font-weight:bold;">Tel:</td><td>${quote.custTel}</td></tr>
                    </table>

                    <h2 style="text-align: center; margin: 0 0 5px 0;">å ±åƒ¹å–®</h2>
                    <h3 style="text-align: center; margin: 0 0 20px 0;">Báº¢NG BÃO GIÃ</h3>
                    
                    <p style="text-align: right; font-size: 13px;">æ—¥æœŸ/ngÃ y thÃ¡ng: ${quote.dateStr}</p>
                    
                    <table border="1" style="width: 100%; border-collapse: collapse; font-size: 13px; text-align: center; margin-top: 10px;">
                        <thead style="background: #f0f0f0;">
                            <tr>
                                <th style="padding: 8px;">STT<br>åºè™Ÿ</th>
                                <th style="padding: 8px;">TÃªn sáº£n pháº©m / Quy cÃ¡ch<br>å“å/å°ºå¯¸</th>
                                <th style="padding: 8px;">Ävt<br>å–®ä½</th>
                                <th style="padding: 8px;">Cháº¥t Liá»‡u<br>æè³ª</th>
                                <th style="padding: 8px;">æ•¸é‡</th>
                                <th style="padding: 8px;">å–®åƒ¹<br>(${quote.currency})</th>
                                <th style="padding: 8px;">é‡‘é¡<br>(${quote.currency})</th>
                                <th style="padding: 8px; width: 25%;">Ghi chÃº<br>å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 8px;">1.0</td>
                                <td style="padding: 8px; text-align: left; white-space: pre-wrap;">${quote.specStr}</td>
                                <td style="padding: 8px;">ç»„</td>
                                <td style="padding: 8px;">${quote.material}</td>
                                <td style="padding: 8px;">${quote.qty}</td>
                                <td style="padding: 8px;">${quote.d.unitPrice.toLocaleString()}</td>
                                <td style="padding: 8px;">${(quote.d.unitPrice * quote.qty).toLocaleString()}</td>
                                <td style="padding: 8px; text-align: left; white-space: pre-wrap; font-size: 11px;">${quote.d.logs.join('\n')}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            html2pdf().from(element).set({
                margin: 10,
                filename: `å ±åƒ¹å–®_${quote.custName}_${quote.dateStr.replace(/\//g, '')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).save();
        }

        initApp();
    </script>
</body>
</html>