const express = require('express');
const app = express();
const path = require('path');

app.use(express.json()); 
app.use(express.static('public')); 

// üîí ÂïÜÊ•≠Ê©üÂØÜÔºöË∂äÂçóÁõæË≥áÊñôÂ∫´ (VND)
const dbVND = {
  "19.0_51.0_64.0": { "TB": { "25.0": 1133000 }, "Pointed": { "25.0": 792000 } },
  "20.0_65.0_80.0": { "TB": { "25.0": 1309000, "30.0": 1386000, "40.0": 1485000 }, "Pointed": { "25.0": 858000, "30.0": 968000, "40.0": 1100000 } },
  "25.0_75.0_90.0": { "TB": { "25.0": 1386000, "30.0": 1452000, "40.0": 1551000, "45.0": 1628000, "55.0": 1727000, "65.0": 2145000, "80.0": 2629000 }, "Pointed": { "25.0": 935000, "30.0": 1034000, "40.0": 1177000, "45.0": 1276000, "55.0": 1419000, "65.0": 1727000, "80.0": 2145000 } },
  "25.0_90.0_105.0": { "TB": { "25.0": 1485000, "30.0": 1584000, "40.0": 1727000, "45.0": 1826000, "55.0": 1969000, "65.0": 2563000, "80.0": 2937000 }, "Pointed": { "25.0": 1034000, "30.0": 1133000, "40.0": 1276000, "45.0": 1419000, "55.0": 1584000, "65.0": 1903000, "80.0": 2277000 } },
  "25.0_100.0_115.0": { "TB": { "25.0": 1551000, "30.0": 1727000, "40.0": 1903000, "45.0": 2079000, "55.0": 2277000, "65.0": 2695000, "80.0": 3080000, "105.0": 3663000 }, "Pointed": { "25.0": 1177000, "30.0": 1276000, "40.0": 1419000, "45.0": 1551000, "55.0": 1727000, "65.0": 2145000, "80.0": 2519000, "105.0": 3322000 } },
  "25.0_108.0_127.0": { "TB": { "25.0": 1628000, "30.0": 1793000, "40.0": 1969000, "45.0": 2178000, "55.0": 2387000, "65.0": 2838000, "80.0": 3146000, "105.0": 3905000, "130.0": 4565000, "155.0": 6237000 }, "Pointed": { "25.0": 1386000, "30.0": 1485000, "40.0": 1584000, "45.0": 1727000, "55.0": 1903000, "65.0": 2321000, "80.0": 2695000, "105.0": 3498000 } },
  "25.0_127.0_140.0": { "TB": { "25.0": 1793000, "30.0": 1969000, "40.0": 2145000, "45.0": 2321000, "55.0": 2486000, "65.0": 3113000, "80.0": 3388000, "105.0": 4433000, "130.0": 5676000, "155.0": 7964000 }, "Pointed": { "25.0": 1584000, "30.0": 1694000, "40.0": 1826000, "45.0": 1969000, "55.0": 2145000, "65.0": 2519000, "80.0": 2937000, "105.0": 3740000, "130.0": 4675000 } },
  "25.0_150.0_165.0": { "TB": { "25.0": 2211000, "40.0": 2563000, "55.0": 2838000, "65.0": 3663000, "80.0": 4290000, "105.0": 5610000, "130.0": 7128000, "155.0": 8866000, "180.0": 11781000 }, "Pointed": { "25.0": 1903000, "40.0": 2145000, "55.0": 2519000, "65.0": 3014000, "80.0": 3663000, "105.0": 4851000, "130.0": 6369000, "155.0": 7964000 } },
  "35.0_190.0_215.0": { "TB": { "25.0": 3322000, "40.0": 3663000, "55.0": 4290000, "65.0": 5335000, "80.0": 5819000, "105.0": 7689000, "130.0": 9350000, "155.0": 10945000, "180.0": 13860000 }, "Pointed": { "40.0": 3322000, "55.0": 4081000, "65.0": 4917000, "80.0": 5544000, "105.0": 6930000, "130.0": 8316000, "155.0": 9702000, "180.0": 11088000 } },
  "38.0_230.0_265.0": { "TB": { "40.0": 5544000, "55.0": 6028000, "65.0": 6435000, "80.0": 7205000, "105.0": 9284000, "130.0": 11913000, "155.0": 14267000, "180.0": 16973000, "205.0": 19404000 }, "Pointed": { "40.0": 5126000, "55.0": 5544000, "65.0": 6094000, "80.0": 6930000, "105.0": 8316000, "130.0": 11088000, "155.0": 12474000, "180.0": 14553000, "205.0": 16632000 } },
  "43.0_290.0_330.0": { "TB": { "55.0": 7766000, "65.0": 8316000, "80.0": 8866000, "105.0": 9350000, "130.0": 11429000, "155.0": 14553000, "180.0": 18018000, "205.0": 20790000 } },
  "50.0_290.0_330.0": { "TB": { "65.0": 9009000, "80.0": 9702000, "105.0": 10395000, "130.0": 11781000, "155.0": 16632000, "180.0": 20790000, "205.0": 23562000 } },
  "50.0_380.0_420.0": { "TB": { "80.0": 10395000, "105.0": 11088000, "130.0": 12474000, "155.0": 15939000, "180.0": 21483000, "205.0": 26334000 } },
  "50.0_400.0_450.0": { "TB": { "80.0": 11781000, "105.0": 13167000, "130.0": 14553000, "155.0": 17325000, "180.0": 22869000, "205.0": 27720000 } }
};

// üîí ÂïÜÊ•≠Ê©üÂØÜÔºöÂè∞Âπ£Ë≥áÊñôÂ∫´ (TWD)
const dbTWD = {
  "19.0_51.0_64.0": { "TB": { "25.0": 1650 }, "Pointed": { "25.0": 1150 } },
  "20.0_65.0_80.0": { "TB": { "25.0": 1900, "30.0": 2000, "40.0": 2150 }, "Pointed": { "25.0": 1250, "30.0": 1400, "40.0": 1600 } },
  "25.0_75.0_90.0": { "TB": { "25.0": 2000, "30.0": 2100, "40.0": 2250, "45.0": 2350, "55.0": 2500, "65.0": 3100, "80.0": 3800 }, "Pointed": { "25.0": 1350, "30.0": 1500, "40.0": 1700, "45.0": 1850, "55.0": 2050, "65.0": 2500, "80.0": 3100 } },
  "25.0_90.0_105.0": { "TB": { "25.0": 2150, "30.0": 2300, "40.0": 2500, "45.0": 2650, "55.0": 2850, "65.0": 3700, "80.0": 4250 }, "Pointed": { "25.0": 1500, "30.0": 1650, "40.0": 1850, "45.0": 2050, "55.0": 2300, "65.0": 2750, "80.0": 3300 } },
  "25.0_100.0_115.0": { "TB": { "25.0": 2250, "30.0": 2500, "40.0": 2750, "45.0": 3000, "55.0": 3300, "65.0": 3900, "80.0": 4450, "105.0": 5300 }, "Pointed": { "25.0": 1700, "30.0": 1850, "40.0": 2050, "45.0": 2250, "55.0": 2500, "65.0": 3100, "80.0": 3650, "105.0": 4800 } },
  "25.0_108.0_127.0": { "TB": { "25.0": 2350, "30.0": 2600, "40.0": 2850, "45.0": 3150, "55.0": 3450, "65.0": 4100, "80.0": 4550, "105.0": 5650, "130.0": 6600, "155.0": 9000 }, "Pointed": { "25.0": 2000, "30.0": 2150, "40.0": 2300, "45.0": 2500, "55.0": 2750, "65.0": 3350, "80.0": 3900, "105.0": 5050 } },
  "25.0_127.0_140.0": { "TB": { "25.0": 2600, "30.0": 2850, "40.0": 3100, "45.0": 3350, "55.0": 3600, "65.0": 4500, "80.0": 4900, "105.0": 6400, "130.0": 8200, "155.0": 11500 }, "Pointed": { "25.0": 2300, "30.0": 2450, "40.0": 2650, "45.0": 2850, "55.0": 3100, "65.0": 3650, "80.0": 4250, "105.0": 5400, "130.0": 6750 } },
  "25.0_150.0_165.0": { "TB": { "25.0": 3200, "40.0": 3700, "55.0": 4100, "65.0": 5300, "80.0": 6200, "105.0": 8100, "130.0": 10300, "155.0": 12800, "180.0": 17000 }, "Pointed": { "25.0": 2750, "40.0": 3100, "55.0": 3650, "65.0": 4350, "80.0": 5300, "105.0": 7000, "130.0": 9200, "155.0": 11500 } },
  "35.0_190.0_215.0": { "TB": { "25.0": 4800, "40.0": 5300, "55.0": 6200, "65.0": 7700, "80.0": 8400, "105.0": 11100, "130.0": 13500, "155.0": 15800, "180.0": 20000 }, "Pointed": { "40.0": 4800, "55.0": 5900, "65.0": 7100, "80.0": 8000, "105.0": 10000, "130.0": 12000, "155.0": 14000, "180.0": 16000 } },
  "38.0_230.0_265.0": { "TB": { "40.0": 8000, "55.0": 8700, "65.0": 9300, "80.0": 10400, "105.0": 13400, "130.0": 17200, "155.0": 20600, "180.0": 24500, "205.0": 28000 }, "Pointed": { "40.0": 7400, "55.0": 8000, "65.0": 8800, "80.0": 10000, "105.0": 12000, "130.0": 16000, "155.0": 18000, "180.0": 21000, "205.0": 24000 } },
  "43.0_290.0_330.0": { "TB": { "65.0": 12000, "80.0": 12800, "105.0": 13500, "130.0": 16500, "155.0": 21000, "180.0": 26000, "205.0": 30000 } },
  "50.0_290.0_330.0": { "TB": { "65.0": 13000, "80.0": 14000, "105.0": 15000, "130.0": 17000, "155.0": 24000, "180.0": 30000, "205.0": 34000 } },
  "50.0_380.0_420.0": { "TB": { "80.0": 15000, "105.0": 16000, "130.0": 18000, "155.0": 23000, "180.0": 31000, "205.0": 38000, "205.0": 45000 } },
  "50.0_400.0_450.0": { "TB": { "80.0": 17000, "105.0": 19000, "130.0": 21000, "155.0": 25000, "180.0": 33000, "205.0": 40000, "205.0": 47000 } }
};

// üîë Ë®ÇÈñ±Âà∂ÔºöÊéàÊ¨äÁ¢ºËàáÂà∞ÊúüÊó•ÁÆ°ÁêÜ
const validTokens = {
    'VIP888': '2026-12-31',
    'BOSS999': '2026-06-30',
    'TEST123': '2026-02-28',
    'JP123456': '2026-04-15'
};

// üõ°Ô∏è Ê™¢Êü•ÊéàÊ¨äÁ¢ºÊòØÂê¶ÊúâÊïàÁöÑÈò≤Ë≠∑Ê©üÂà∂
function checkAuth(req, res, next) {
    const token = req.headers['authorization'];
    if (validTokens.hasOwnProperty(token)) {
        const expireDateStr = validTokens[token];
        const expireDate = new Date(expireDateStr + 'T23:59:59+08:00'); 
        const now = new Date(); 
        if (now <= expireDate) {
            next(); 
        } else {
            res.status(401).json({ success: false, error: `‚õî ÊéàÊ¨äÂ∑≤Êñº ${expireDateStr} Âà∞ÊúüÔºåË´ãËÅØÁµ°ÁÆ°ÁêÜÂì°„ÄÇ` });
        }
    } else {
        res.status(401).json({ success: false, error: '‚õî ÊéàÊ¨äÁ¢ºÁÑ°ÊïàÔºåË´ãÁ¢∫Ë™çËº∏ÂÖ•ÊòØÂê¶Ê≠£Á¢∫„ÄÇ' });
    }
}

// üåü Êñ∞Â¢ûÔºöÂ∞àÈñÄÁî®‰æÜÊü•„ÄåÂà∞ÊúüÊó•„ÄçÁöÑ API
app.post('/api/verify', (req, res) => {
    const token = req.headers['authorization'];
    if (validTokens.hasOwnProperty(token)) {
        res.json({ success: true, expireDate: validTokens[token] });
    } else {
        res.json({ success: false });
    }
});

// ‚öôÔ∏è Ë®àÁÆó API
app.post('/api/calculate', checkAuth, (req, res) => {
    const { t, h, f, m, type, currency, wireFee, discount, multipliers, options } = req.body;
    const token = req.headers['authorization']; 
    let logs = [];
    
    // Ê±∫ÂÆöË¶ÅÁî®Âì™Â•óË≥áÊñôÂ∫´ (ÁæéÈáëÁî® TWD Ë≥áÊñôÂ∫´ÂéªÊèõÁÆó)
    let currentDB = (currency === 'VND') ? dbVND : dbTWD;
    
    const key = `${t.toFixed(1)}_${f.toFixed(1)}_${m.toFixed(1)}`;
    
    if (!currentDB[key]) {
        return res.json({ success: false, error: `Êü•ÁÑ°Ê≠§Ë¶èÊ†º: ${t} x ${f} x ${m}` });
    }

    const typeData = currentDB[key][type] || currentDB[key]['TB'];
    if (type === 'Pointed' && !typeData) {
        return res.json({ success: false, error: "Ê≠§Ë¶èÊ†ºÁÑ°„ÄåÂ∞ñÂ∞æ„ÄçÂÉπÊ†º" });
    }

    const heights = Object.keys(typeData).map(parseFloat).sort((a,b) => a - b);
    let matchH = heights.find(val => val >= h);
    let warning = "";
    if (!matchH) {
        matchH = heights[heights.length-1];
        warning = " (È´òÂ∫¶Ë∂ÖÊ®ôÔºå‰ª•ÊúÄÂ§ßÂÄºË®à)";
    }

    let total = typeData[matchH.toFixed(1)];
    logs.push(`Âü∫Á§éÂÉπÊ†º (${key.replace(/_/g,'x')}, H=${matchH}): ${total.toLocaleString()} ${currency === 'USD' ? 'TWD(Âü∫Â∫ï)' : currency}` + warning);

    // ËôïÁêÜÊùêË≥™ËàáÁøª‰øÆ (ÂãïÊÖãÂ•óÁî®ÂâçÁ´ØÂÇ≥‰æÜÁöÑÂÄçÁéá)
    let multiplier = 1.0;
    if (options.skh9) { 
        const val = (multipliers && multipliers.skh9) ? multipliers.skh9 : 1.8;
        multiplier *= val; 
        logs.push(`ÊùêË≥™ SKH-9 (x${val})`); 
    }
    if (options.refurbish) { 
        const val = (multipliers && multipliers.refurbish) ? multipliers.refurbish : 0.6;
        multiplier *= val; 
        logs.push(`Áøª‰øÆÂìÅ (x${val})`); 
    }
    if (options.shapeX2) { multiplier *= 2; logs.push("ËßíÁâô/ÊñπÁâô (x2)"); }
    total *= multiplier;

    // ËôïÁêÜÂõ∫ÂÆöÂä†Êàê
    let pct = 0;
    if (options.deepen20) { pct += 0.20; logs.push("Ê©üÁâôÂä†Ê∑± (+20%)"); }
    if (options.reverseTri30) { pct += 0.30; logs.push("‰∏âËßíÁâô/ÂèçÂÖ•Âè£ (+30%)"); }
    if (options.complex50) { pct += 0.50; logs.push("ÁâπÊÆäÁâôÂûã (+50%)"); }
    if (options.pitch04) { pct += 0.15; logs.push("ÁâôË∑ù0.4‰ª•‰∏ã (+15%)"); }
    if (options.twoSpecs) { pct += 0.30; logs.push("ÈõôË¶èÊ†º (+30%)"); }
    if (options.doubleLeft) { pct += 0.10; logs.push("ÈõôÁâô/Â∑¶Áâô (+10%)"); }
    if (options.angle3048) { pct += 0.10; logs.push("ÁâôÂ±±30-48Â∫¶ (+10%)"); }
    if (options.faces4) { pct += 0.50; logs.push("ÂõõÈù¢Áî® (+50%)"); }
    if (options.surface) { pct += 0.15; logs.push("Ë°®Èù¢ËôïÁêÜ (+15%)"); }
    if (options.straight42) { pct += 0.30; logs.push("Áõ¥ÈΩí42Áâô+ (+30%)"); }

    if (pct > 0) {
        let add = total * pct;
        total += add;
        logs.push(`Âä†ÊàêÂ∞èË®à: +${Math.round(add).toLocaleString()}`);
    }

    // Á∑öÂâ≤Ë≤ª
    if (wireFee && wireFee > 0) {
        total += wireFee;
        logs.push(`Á∑öÂâ≤Ë≤ª: +${wireFee.toLocaleString()}`);
    }

    // ÁæéÈáëÊèõÁÆó (ÂÅáË®≠ÂåØÁéáÁÇ∫ 32ÔºåÊÇ®ÂèØËá™Ë°å‰øÆÊîπ)
    const usdRate = 32.0;
    if (currency === 'USD') {
        let oldTWD = total;
        total = total / usdRate;
        logs.push(`ËΩâÊèõÁæéÈáë (ÂåØÁéá 1:${usdRate}): TWD ${Math.round(oldTWD).toLocaleString()} -> USD ${total.toFixed(2)}`);
    }

    // ËôïÁêÜÊäòÊâ£
    if (discount > 0 && discount <= 10) {
        let oldTotal = total;
        total = total * (discount / 10);
        let diff = oldTotal - total;
        
        if (currency === 'USD') {
            logs.push(`ÊäòÊï∏ (${discount}Êäò): -${diff.toFixed(2)}`);
        } else {
            logs.push(`ÊäòÊï∏ (${discount}Êäò): -${Math.round(diff).toLocaleString()}`);
        }
    }

    // ÂõûÂÇ≥ÁµêÊûú
    const finalVal = (currency === 'USD') ? Number(total.toFixed(2)) : Math.round(total);
    
    // üëâ ÊääË®àÁÆóÂá∫‰æÜÁöÑÂÉπÊ†ºË∑ü„ÄåÂà∞ÊúüÊó•„Äç‰∏ÄËµ∑ÂÇ≥ÂõûÂâçÁ´Ø
    res.json({ 
        success: true, 
        finalPrice: finalVal, 
        logs: logs,
        expireDate: validTokens[token]
    });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`‰º∫ÊúçÂô®ÈÅã‰Ωú‰∏≠: Port ${PORT}`));