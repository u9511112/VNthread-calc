<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰™æ¿å ±åƒ¹è¨ˆç®—å™¨</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; background-color: #f2f2f7; padding: 15px; padding-bottom: 100px; color: #333; margin: 0; }
        
        /* å¢åŠ  position: relative è®“å³ä¸Šè§’çš„åˆ°æœŸæ—¥æ¨™ç±¤èƒ½ç²¾æº–å®šä½ */
        .container { position: relative; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        h2 { text-align: center; color: #333; margin-bottom: 15px; font-weight: 700; margin-top: 5px; }
        
        /* ğŸŒŸ å³ä¸Šè§’åˆ°æœŸæ—¥æ¨™ç±¤æ¨£å¼ */
        #expiry-badge { position: absolute; top: 15px; right: 15px; font-size: 0.75rem; background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 12px; display: none; font-weight: bold; border: 1px solid #c8e6c9; }

        .top-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .top-controls select { padding: 10px; font-size: 15px; border-radius: 8px; background-color: #f8f9fa; border: 1px solid #ccc; }
        .auth-group { background: #e1f5fe; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #b3e5fc; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; color: #555; }
        select, input[type="number"], input[type="password"] { width: 100%; padding: 14px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; background-color: #fff; box-sizing: border-box; appearance: none; -webkit-appearance: none; }
        select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; }
        input:focus, select:focus { border-color: #007aff; outline: none; }
        
        .var-section { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .var-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .var-input { width: 80px !important; padding: 8px !important; text-align: center; color: #d35400; font-weight: bold; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .check-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; padding: 2px; }
        .check-item input { width: 20px; height: 20px; accent-color: #007aff; }
        
        .btn-calc { width: 100%; background-color: #007aff; color: white; font-size: 1.2rem; font-weight: bold; padding: 16px; border: none; border-radius: 12px; margin-top: 25px; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3); cursor: pointer; }
        .btn-calc:active { transform: scale(0.98); background-color: #0062cc; }
        
        .result-box { background: #1c1c1e; color: white; padding: 25px; border-radius: 15px; margin-top: 25px; text-align: center; }
        .price-container { display: flex; justify-content: center; align-items: baseline; gap: 5px; }
        .price-val { font-size: 2.5rem; font-weight: 800; color: #30d158; line-height: 1.2; }
        .currency-unit { font-size: 1.2rem; color: #8e8e93; font-weight: 600; }
        #result-log { font-size: 0.85rem; margin-top: 15px; color: #aaa; text-align: left; white-space: pre-line; line-height: 1.5; border-top: 1px solid #333; padding-top: 15px; }
        .error-msg { background: #ffebee; color: #c62828; padding: 12px; border-radius: 8px; margin-top: 15px; display: none; font-weight: bold; text-align: center; font-size: 0.95rem; }
    </style>
</head>
<body>

    <div class="container">
        <div id="expiry-badge">â³ é©—è­‰ä¸­...</div>

        <h2 id="t_title">æ“ç‰™æ¿è¨ˆç®—å™¨</h2>

        <div class="top-controls">
            <select id="lang" onchange="changeLanguage()">
                <option value="zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ (ç¹é«”)</option>
                <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                <option value="en">ğŸ‡ºğŸ‡¸ English</option>
            </select>
            <select id="currency" onchange="changeCurrency()">
                <option value="TWD">NT$ å°å¹£ (TWD)</option>
                <option value="VND">â‚« è¶Šç›¾ (VND)</option>
                <option value="USD">$ ç¾é‡‘ (USD)</option>
            </select>
        </div>

        <div class="form-group auth-group">
            <label id="t_auth" style="color: #0277bd;">ğŸ”‘ ç³»çµ±æˆæ¬Šç¢¼ (Auth Code)</label>
            <input type="password" id="auth_token" placeholder="VIP888" style="border: 1px solid #0288d1;">
        </div>

        <div class="form-group">
            <label id="t_thick">1. é¸æ“‡åšåº¦ (Thickness)</label>
            <select id="sel_thick" onchange="populateSpecs()"></select>
        </div>

        <div class="form-group">
            <label id="t_spec">2. é¸æ“‡é•·åº¦ (å›ºå®š / ç§»å‹•)</label>
            <select id="sel_spec" onchange="clearResult()"></select>
        </div>

        <div class="form-group">
            <label id="t_height">3. è¼¸å…¥é«˜åº¦ (Height)</label>
            <input type="number" id="in_height" inputmode="decimal">
        </div>

        <div class="form-group">
            <label id="t_type">4. é¡åˆ¥ (Type)</label>
            <select id="type">
                <option value="TB" id="t_type_tb">æ©Ÿæ¢°ç‰™æ¿ (Machine / T-B)</option>
                <option value="Pointed" id="t_type_pt">å°–å°¾ç‰™æ¿ (Pointed Tail)</option>
            </select>
        </div>

        <div class="form-group">
            <label id="t_discount" style="color:#ff3b30;">5. æŠ˜æ‰£ (Discount)</label>
            <select id="discount"></select>
        </div>

        <div class="form-group" id="wire-fee-box" style="padding:10px; border:1px dashed #999; border-radius:8px;">
            <label id="t_wire">ç·šå‰²è²» (Wire Cut)</label>
            <select id="wire">
                <option value="0" id="t_wire_none">ç„¡ (None)</option>
                <option value="116000">JP ç‰™æ¿ (116,000 VND / 170 TWD)</option>
                <option value="231000">é JP (231,000 VND / 340 TWD)</option>
            </select>
        </div>

        <div class="var-section">
            <div class="var-row">
                <label class="check-item"><input type="checkbox" id="opt_skh9" onchange="toggleInput('val_skh9')"> <span id="t_opt_skh9">SKH-9 (é«˜é€Ÿé‹¼)</span></label>
                <div style="display:flex; align-items:center; gap:5px; color:#777; font-size:0.9rem;">
                    x <input type="number" id="val_skh9" class="var-input" value="1.8" step="0.1" disabled>
                </div>
            </div>
            <div class="var-row">
                <label class="check-item"><input type="checkbox" id="opt_refurbish" onchange="toggleInput('val_refurbish')"> <span id="t_opt_ref">ç¿»ä¿®å“ (Refurbish)</span></label>
                <div style="display:flex; align-items:center; gap:5px; color:#777; font-size:0.9rem;">
                    x <input type="number" id="val_refurbish" class="var-input" value="0.6" step="0.1" disabled>
                </div>
            </div>
        </div>

        <div class="options-grid">
            <label class="check-item"><input type="checkbox" id="opt_deepen20"> <span id="t_o1">æ©Ÿç‰™åŠ æ·± (+20%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_triangle"> <span id="t_o2">ä¸‰è§’ç‰™/åå…¥å£ (+30%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_special50"> <span id="t_o3">ç‰¹æ®Šç‰™å‹ (+50%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_pitch04"> <span id="t_o4">ç‰™è·0.4ä»¥ä¸‹ (+15%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_shapeX2"> <span id="t_o5">è§’/æ–¹ç‰™ (x2)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_twoSpecs"> <span id="t_o6">é›™è¦æ ¼ (+30%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_doubleLeft"> <span id="t_o7">é›™ç‰™/å·¦ç‰™ (+10%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_angle3048"> <span id="t_o8">ç‰™å±±30-48åº¦ (+10%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_4faces"> <span id="t_o9">å››é¢ç”¨ (+50%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_surface"> <span id="t_o10">è¡¨é¢è™•ç† (+15%)</span></label>
            <label class="check-item"><input type="checkbox" id="opt_straight42"> <span id="t_o11">ç›´é½’42ç‰™+ (+30%)</span></label>
        </div>

        <button class="btn-calc" onclick="calculate()" id="t_btn">é€£ç·šè¨ˆç®— (Calculate)</button>
        <div id="error-box" class="error-msg"></div>

        <div class="result-box">
            <div class="price-container">
                <span class="price-val" id="final-price">0</span>
                <span class="currency-unit" id="final-currency">TWD</span>
            </div>
            <div id="result-log"></div>
        </div>
    </div>

    <script>
        const i18n = {
            zh: {
                title: "æ“ç‰™æ¿è¨ˆç®—å™¨", auth: "ğŸ”‘ ç³»çµ±æˆæ¬Šç¢¼", thick: "1. é¸æ“‡åšåº¦", spec: "2. é¸æ“‡é•·åº¦ (å›ºå®š/ç§»å‹•)",
                height: "3. è¼¸å…¥é«˜åº¦", type: "4. é¡åˆ¥", discount: "5. æŠ˜æ‰£", wire: "ç·šå‰²è²»",
                type_tb: "æ©Ÿæ¢°ç‰™æ¿ (T-B)", type_pt: "å°–å°¾ç‰™æ¿ (Pointed)", wire_none: "ç„¡",
                opt_skh9: "SKH-9 (é«˜é€Ÿé‹¼)", opt_ref: "ç¿»ä¿®å“",
                o1: "æ©Ÿç‰™åŠ æ·± (+20%)", o2: "ä¸‰è§’ç‰™/åå…¥å£ (+30%)", o3: "ç‰¹æ®Šç‰™å‹ (+50%)", o4: "ç‰™è·0.4ä»¥ä¸‹ (+15%)",
                o5: "è§’/æ–¹ç‰™ (x2)", o6: "é›™è¦æ ¼ (+30%)", o7: "é›™ç‰™/å·¦ç‰™ (+10%)", o8: "ç‰™å±±30-48åº¦ (+10%)",
                o9: "å››é¢ç”¨ (+50%)", o10: "è¡¨é¢è™•ç† (+15%)", o11: "ç›´é½’42ç‰™+ (+30%)",
                btn: "é€£ç·šè¨ˆç®—", placeholder_h: "ä¾‹å¦‚: 30", msg_waiting: "ç­‰å¾…è¼¸å…¥..."
            },
            vi: {
                title: "MÃ¡y tÃ­nh BÃ n chÃ  ren", auth: "ğŸ”‘ MÃ£ báº£n quyá»n", thick: "1. Chá»n Ä‘á»™ dÃ y", spec: "2. Chá»n chiá»u dÃ i (Cá»‘ Ä‘á»‹nh/Di Ä‘á»™ng)",
                height: "3. Nháº­p chiá»u cao", type: "4. Loáº¡i", discount: "5. Chiáº¿t kháº¥u", wire: "PhÃ­ cáº¯t dÃ¢y",
                type_tb: "BÃ n chÃ  ren mÃ¡y (T-B)", type_pt: "BÃ n chÃ  ren mÅ©i nhá»n", wire_none: "KhÃ´ng",
                opt_skh9: "SKH-9 (ThÃ©p giÃ³)", opt_ref: "HÃ ng phá»¥c há»“i",
                o1: "Ren sÃ¢u (+20%)", o2: "Ren tam giÃ¡c (+30%)", o3: "Ren Ä‘áº·c biá»‡t (+50%)", o4: "BÆ°á»›c ren < 0.4 (+15%)",
                o5: "Ren vuÃ´ng (x2)", o6: "Hai quy cÃ¡ch (+30%)", o7: "Ren trÃ¡i/kÃ©p (+10%)", o8: "GÃ³c 30-48 Ä‘á»™ (+10%)",
                o9: "DÃ¹ng 4 máº·t (+50%)", o10: "Xá»­ lÃ½ bá» máº·t (+15%)", o11: "RÄƒng tháº³ng 42+ (+30%)",
                btn: "TÃ­nh toÃ¡n", placeholder_h: "VD: 30", msg_waiting: "Chá» nháº­p liá»‡u..."
            },
            en: {
                title: "Thread Rolling Die Calculator", auth: "ğŸ”‘ Auth Code", thick: "1. Select Thickness", spec: "2. Select Length (Fixed/Moving)",
                height: "3. Enter Height", type: "4. Type", discount: "5. Discount", wire: "Wire Cut Fee",
                type_tb: "Machine Die (T-B)", type_pt: "Pointed Tail Die", wire_none: "None",
                opt_skh9: "SKH-9 (High-Speed)", opt_ref: "Refurbished",
                o1: "Deep Thread (+20%)", o2: "Triangle Thread (+30%)", o3: "Special Thread (+50%)", o4: "Pitch < 0.4 (+15%)",
                o5: "Square Thread (x2)", o6: "Dual Specs (+30%)", o7: "Left/Double Thread (+10%)", o8: "Angle 30-48 (+10%)",
                o9: "4-Face Use (+50%)", o10: "Surface Treat (+15%)", o11: "Straight 42+ (+30%)",
                btn: "Calculate", placeholder_h: "e.g. 30", msg_waiting: "Waiting for input..."
            }
        };

        const availableSpecs = [
            "19.0_51.0_64.0", "20.0_65.0_80.0", "25.0_75.0_90.0", "25.0_90.0_105.0",
            "25.0_100.0_115.0", "25.0_108.0_127.0", "25.0_127.0_140.0", "25.0_150.0_165.0",
            "35.0_190.0_215.0", "38.0_230.0_265.0", "43.0_290.0_330.0", "50.0_290.0_330.0",
            "50.0_380.0_420.0", "50.0_400.0_450.0"
        ];

        // ç¶²é å•Ÿå‹•æ™‚åŸ·è¡Œçš„å‹•ä½œ
        function initApp() {
            changeLanguage();
            changeCurrency();
            populateDiscount();
            populateThick();

            // ğŸŒŸ è®€å–ç€è¦½å™¨è¨˜æ†¶çš„å¯†ç¢¼
            const savedToken = localStorage.getItem('threadCalcToken');
            if (savedToken) {
                document.getElementById('auth_token').value = savedToken;
                verifyToken(savedToken); // è‡ªå‹•å»å¾Œç«¯æŸ¥åˆ°æœŸæ—¥
            }
        }

        // ğŸŒŸ å»å¾Œç«¯é©—è­‰å¯†ç¢¼èˆ‡å–å¾—æ—¥æœŸçš„å‡½æ•¸
        async function verifyToken(token) {
            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Authorization': token }
                });
                const result = await response.json();
                const badge = document.getElementById('expiry-badge');
                
                if (result.success) {
                    badge.style.display = 'block';
                    badge.innerText = `â³ åˆ°æœŸ: ${result.expireDate}`;
                } else {
                    // å¦‚æœå¯†ç¢¼éæœŸæˆ–è¢«ç®¡ç†å“¡åˆªé™¤ï¼Œå°±æŠŠæ‰‹æ©Ÿçš„è¨˜æ†¶æ¸…ç©º
                    localStorage.removeItem('threadCalcToken');
                    badge.style.display = 'none';
                }
            } catch (e) {
                console.log("ç„¡æ³•è‡ªå‹•é©—è­‰æˆæ¬Šç¢¼ç‹€æ…‹");
            }
        }

        function changeLanguage() {
            const lang = document.getElementById('lang').value;
            const text = i18n[lang];
            
            document.getElementById('t_title').innerText = text.title;
            document.getElementById('t_auth').innerText = text.auth;
            document.getElementById('t_thick').innerText = text.thick;
            document.getElementById('t_spec').innerText = text.spec;
            document.getElementById('t_height').innerText = text.height;
            document.getElementById('t_type').innerText = text.type;
            document.getElementById('t_discount').innerText = text.discount;
            document.getElementById('t_wire').innerText = text.wire;
            
            document.getElementById('t_type_tb').innerText = text.type_tb;
            document.getElementById('t_type_pt').innerText = text.type_pt;
            document.getElementById('t_wire_none').innerText = text.wire_none;
            
            document.getElementById('t_opt_skh9').innerText = text.opt_skh9;
            document.getElementById('t_opt_ref').innerText = text.opt_ref;
            for(let i=1; i<=11; i++) { document.getElementById('t_o'+i).innerText = text['o'+i]; }
            
            document.getElementById('t_btn').innerText = text.btn;
            document.getElementById('in_height').placeholder = text.placeholder_h;
            if(document.getElementById('final-price').innerText === "0") {
                document.getElementById('result-log').innerText = text.msg_waiting;
            }
        }

        function changeCurrency() {
            const cur = document.getElementById('currency').value;
            document.getElementById('final-currency').innerText = cur;
            
            const wireSel = document.getElementById('wire');
            if(cur === 'VND') {
                wireSel.options[1].value = "116000"; wireSel.options[2].value = "231000";
            } else if (cur === 'TWD' || cur === 'USD') {
                wireSel.options[1].value = "170"; wireSel.options[2].value = "340";
            }
            clearResult();
        }

        function toggleInput(id) {
            const checkbox = document.getElementById(id.replace('val', 'opt'));
            document.getElementById(id).disabled = !checkbox.checked;
        }

        function populateDiscount() {
            const sel = document.getElementById('discount');
            sel.innerHTML = '<option value="10">ç„¡ (None)</option>';
            for (let i = 99; i >= 50; i--) {
                let val = (i / 10).toFixed(1);
                sel.add(new Option(val.endsWith('.0') ? val.substring(0, val.length - 2) + "æŠ˜" : val + "æŠ˜", val));
            }
        }

        function populateThick() {
            const sel = document.getElementById('sel_thick');
            sel.innerHTML = '<option value="">...</option>';
            const thicks = new Set(availableSpecs.map(key => key.split('_')[0]));
            Array.from(thicks).sort((a, b) => parseFloat(a) - parseFloat(b)).forEach(t => sel.add(new Option(t + " mm", t)));
        }

        function populateSpecs() {
            const thick = document.getElementById('sel_thick').value;
            const sel = document.getElementById('sel_spec');
            sel.innerHTML = '<option value="">...</option>';
            if (!thick) return;
            availableSpecs.filter(k => k.startsWith(thick + "_")).forEach(key => {
                const parts = key.split('_');
                sel.add(new Option(`å›ºå®š: ${parts[1]} / ç§»å‹•: ${parts[2]}`, key));
            });
            clearResult();
        }

        function clearResult() {
            document.getElementById('final-price').innerText = "0";
            document.getElementById('result-log').innerText = i18n[document.getElementById('lang').value].msg_waiting;
            document.getElementById('error-box').style.display = 'none';
        }

        async function calculate() {
            const token = document.getElementById('auth_token').value;
            const errorBox = document.getElementById('error-box');
            const priceDisplay = document.getElementById('final-price');
            const logArea = document.getElementById('result-log');
            
            const specKey = document.getElementById('sel_spec').value;
            const hInput = document.getElementById('in_height').value;

            if(!token) { errorBox.style.display = 'block'; errorBox.innerText = "â›” è«‹è¼¸å…¥æˆæ¬Šç¢¼ (Auth Code)"; return; }
            if (!specKey || !hInput) { errorBox.style.display = 'block'; errorBox.innerText = "è«‹ç¢ºèªè¦æ ¼å¡«å¯«å®Œæ•´"; return; }

            const [t, f, m] = specKey.split('_').map(Number);
            const currency = document.getElementById('currency').value;
            let wireVal = parseFloat(document.getElementById('wire').value) || 0;

            const payload = {
                t: t, h: parseFloat(hInput), f: f, m: m,
                type: document.getElementById('type').value,
                currency: currency,
                wireFee: wireVal,
                discount: parseFloat(document.getElementById('discount').value) || 0,
                multipliers: {
                    skh9: parseFloat(document.getElementById('val_skh9').value) || 1.8,
                    refurbish: parseFloat(document.getElementById('val_refurbish').value) || 0.6
                },
                options: {
                    skh9: document.getElementById('opt_skh9').checked,
                    refurbish: document.getElementById('opt_refurbish').checked,
                    shapeX2: document.getElementById('opt_shapeX2').checked,
                    deepen20: document.getElementById('opt_deepen20').checked,
                    reverseTri30: document.getElementById('opt_triangle').checked,
                    complex50: document.getElementById('opt_special50').checked,
                    pitch04: document.getElementById('opt_pitch04').checked,
                    twoSpecs: document.getElementById('opt_twoSpecs').checked,
                    doubleLeft: document.getElementById('opt_doubleLeft').checked,
                    angle3048: document.getElementById('opt_angle3048').checked,
                    faces4: document.getElementById('opt_4faces').checked,
                    surface: document.getElementById('opt_surface').checked,
                    straight42: document.getElementById('opt_straight42').checked
                }
            };

            priceDisplay.innerText = "...";
            errorBox.style.display = 'none';

            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (result.success) {
                    priceDisplay.innerText = result.finalPrice.toLocaleString();
                    logArea.innerText = result.logs.join('\n');
                    
                    // ğŸŒŸ è¨ˆç®—æˆåŠŸï¼ä»£è¡¨å¯†ç¢¼æ­£ç¢ºï¼Œå°‡å¯†ç¢¼å­˜å…¥æ‰‹æ©Ÿè¨˜æ†¶é«”ä¸­
                    localStorage.setItem('threadCalcToken', token);
                    
                    // åŒæ­¥æ›´æ–°å³ä¸Šè§’çš„æ¨™ç±¤
                    const badge = document.getElementById('expiry-badge');
                    badge.style.display = 'block';
                    badge.innerText = `â³ åˆ°æœŸ: ${result.expireDate}`;

                } else {
                    errorBox.style.display = 'block';
                    errorBox.innerText = result.error;
                    priceDisplay.innerText = "0";
                }
            } catch (error) {
                errorBox.style.display = 'block';
                errorBox.innerText = "ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨ã€‚ Server Error.";
            }
        }

        initApp();
    </script>
</body>
</html>